

### 20210712_Writing by YF

# tidyverseとは



>  tidyverseは以下のパッケージをまとめたパッケージ集．
>
>  - ggplot2: グラフ描画パッケージ
>
>  - dplyr: データ操作パッケージ
>
>  - tidyr: tidy dataを作るためのパッケージ
>
>  - readr: データファイル読み込みパッケージ
>
>  - purrr: 繰り返し計算を行うためのツール
>
>  - tibble: tidyverseの世界で使うデータ形式。データフレームの一種
>
>  - stringr: 文字列操作ライブラリ
>
>  - forcats: ファクタ(因子)操作ライブラリ
>
>  
>
>  Rで表形式のデータ処理・解析をするための [tidyverse](https://www.tidyverse.org/)パッケージがとても良くできている。 Rを使うのに，別にtidyverseは使わなくても大抵のことはできるんだけど，Rの基本的なvectorとかmatrixとかarrayとかlapplyとかplotとかのお勉強はすっ飛ばして，さっさとtidyverseの世界に入った方が，可読性の高いスクリプトを早く書けるようになって良いのではと思う。
>
>  
>
>  引用 (http://bcl.sci.yamaguchi-u.ac.jp/~jun/notebook/r/tidyverse/)



tidyverse HP
https://www.tidyverse.org/



# tidyverseの導入



インストールは1度だけでOK
library()はセッションが切れる度に必要

```R
# インストール (1回のみ)
install.packages("tidyverse")

# load package
library(tidyverse)
```



# データハンドリングあれこれ



## 行，列の理解

今一度，データフレームにおける行と列を確認．

行: row

列: col

```R
# 行数を取得 (nrow())
nrow(d)

# 列数を取得 (ncol() or length())
ncol(d)
length(d)
```



## 使用するデモデータ

本記事でのデモデータおよびスクリプトファイルはFuk (tonegawa07) のGithubからもダウンロード可能

https://github.com/tonegawa07/Lab_R_Seminar/tree/master/03_tidyverse_datahandling_1



処理区: -Al区, +Al区

反復数: n=4

部位: 新葉 (NL)，成葉 (ML)，白色根 (WR)

測定項目: Chlorophyll, Ionome (13 minerals)

| treatment | n    | part | Chl_a       | Chl_b       | Al          | Fe          | Na          | B           | P           | S           | Si          | Ca          | Cu          | K           | Mg          | Mn          | Zn          |
| --------- | ---- | ---- | ----------- | ----------- | ----------- | ----------- | ----------- | ----------- | ----------- | ----------- | ----------- | ----------- | ----------- | ----------- | ----------- | ----------- | ----------- |
| minusAl   | 1    | NL   | 7.012684391 | 2.353361921 | 0.178765525 | 0.133502088 | 0.604551147 | 0.035487106 | 3.918749999 | 3.2603298   | 0.092385106 | 4.43935116  | 0.006757444 | 9.362802021 | 1.634951748 | 0.593645733 | 0.027605377 |
| minusAl   | 2    | NL   | 6.698333333 | 2.182391714 | 0.167122902 | 0.098583939 | 0.454368808 | 0.032142086 | 4.065937965 | 3.04593638  | 0.103160285 | 3.748617645 | 0.006525771 | 10.23924714 | 1.571978261 | 0.506675137 | 0.031023565 |
| minusAl   | 3    | NL   | 6.407278369 | 2.048280142 | 0.155344844 | 0.108510738 | 0.374604197 | 0.029527298 | 4.097699658 | 3.505802782 | 0.111835804 | 3.449250946 | 0.007949058 | 11.17415479 | 1.811214748 | 0.438575225 | 0.030577295 |
| minusAl   | 4    | NL   | 5.9038      | 1.89248     | 0.199477536 | 0.136366122 | 0.647776262 | 0.029597052 | 4.08363422  | 3.304531473 | 0.112292381 | 4.794553315 | 0.006971217 | 10.21903781 | 1.807767003 | 0.601705904 | 0.030181155 |
| plusAl    | 1    | NL   | 5.84099278  | 1.816570397 | 0.41977391  | 0.086903427 | 0.437809644 | 0.024433674 | 4.002366642 | 2.473186624 | 0.102601035 | 3.683349098 | 0.005488768 | 8.766010242 | 1.306170309 | 0.71152022  | 0.023408438 |
| plusAl    | 2    | NL   | 5.499825368 | 1.8709375   | 0.440642875 | 0.100976419 | 0.46971514  | 0.025592641 | 3.951560765 | 2.558580395 | 0.109863863 | 3.559170854 | 0.007646982 | 8.639570977 | 1.243342421 | 0.711716208 | 0.027322618 |
| plusAl    | 3    | NL   | 5.311014235 | 1.694626335 | 0.391616714 | 0.092397222 | 0.583584902 | 0.025075353 | 3.906627198 | 2.759047366 | 0.107993374 | 4.121630563 | 0.00998771  | 9.635240212 | 1.532425754 | 0.840264248 | 0.024825856 |
| plusAl    | 4    | NL   | 5.579825368 | 1.7708475   | 0.361057131 | 0.08133952  | 0.279911139 | 0.025564854 | 3.890502844 | 2.677970411 | 0.108204474 | 3.02385587  | 0.005910936 | 10.34682411 | 1.606282754 | 0.614116665 | 0.030304172 |
| minusAl   | 1    | ML   | 7.772695652 | 2.608834783 | 0.569512396 | 0.1258376   | 0.462018021 | 0.063658837 | 1.996620121 | 4.409933119 | 0.251927289 | 9.570564499 | 0.0045541   | 3.93976894  | 3.520192896 | 1.415590795 | 0.01130654  |
| minusAl   | 2    | ML   | 9.508439306 | 3.352755299 | 0.6053303   | 0.125069082 | 0.542565079 | 0.054419238 | 1.744678413 | 4.067321346 | 0.274179983 | 9.541209696 | 0.005275184 | 4.688973416 | 3.616677555 | 1.189056849 | 0.011284415 |
| minusAl   | 3    | ML   | 8.457400756 | 2.776767486 | 0.530170162 | 0.096227232 | 0.559127749 | 0.059328105 | 1.724970873 | 4.641400516 | 0.292301945 | 8.509362488 | 0.009696305 | 5.594338404 | 4.226801851 | 0.930474138 | 0.017694306 |
| minusAl   | 4    | ML   | 8.204903101 | 2.601124031 | 0.630816562 | 0.16360268  | 0.46084798  | 0.04808161  | 2.07485005  | 5.464089146 | 0.269266481 | 9.598710734 | 0.005158617 | 4.887123465 | 4.24979672  | 1.1109254   | 0.011823247 |
| plusAl    | 1    | ML   | 6.190541339 | 1.919547244 | 1.714457721 | 0.182493579 | 0.456024519 | 0.047108286 | 2.957198081 | 3.751139839 | 0.328420396 | 9.921357168 | 0.004423053 | 4.354563583 | 2.813118948 | 1.981927194 | 0.012432671 |
| plusAl    | 2    | ML   | 6.860633028 | 2.241009174 | 1.620132851 | 0.169315354 | 0.602042391 | 0.051992089 | 3.359863062 | 3.810403764 | 0.28778023  | 9.765423699 | 0.004411335 | 4.107758126 | 2.690742896 | 2.053398773 | 0.009139915 |
| plusAl    | 3    | ML   | 5.964130019 | 1.903021033 | 1.582964663 | 0.178576533 | 0.448372275 | 0.059977185 | 2.263485566 | 4.172430148 | 0.300852621 | 9.756714165 | 0.00474336  | 4.812118063 | 4.148637822 | 1.825718524 | 0.013211083 |
| plusAl    | 4    | ML   | 6.278633028 | 2.073009174 | 1.706103016 | 0.151462937 | 0.566439702 | 0.058924374 | 2.061243058 | 4.691212825 | 0.320692918 | 9.185149609 | 0.004096952 | 5.017798203 | 3.910615785 | 1.807981528 | 0.009565393 |
| minusAl   | 1    | WR   | NA          | NA          | 0.222010172 | 0.786380117 | 0.453657188 | 0.01646084  | 9.650618766 | 7.490253272 | 0.148592513 | 1.313818508 | 0.022526813 | 17.35977482 | 1.63001529  | 0.168083777 | 0.064254656 |
| minusAl   | 2    | WR   | NA          | NA          | 0.33002751  | 0.847989541 | 0.380506955 | 0.016071603 | 9.888801788 | 7.18915329  | 0.140691068 | 1.907085133 | 0.023767139 | 18.14438327 | 2.403683864 | 0.2418222   | 0.073428316 |
| minusAl   | 3    | WR   | NA          | NA          | 0.321143587 | 0.823893696 | 0.80046235  | 0.016290222 | 9.211809166 | 8.240729645 | 0.151414385 | 2.249088447 | 0.025330166 | 19.22199496 | 1.958615808 | 0.227761046 | 0.075585878 |
| minusAl   | 4    | WR   | NA          | NA          | 0.315370685 | 1.119852876 | 0.468695663 | 0.015335686 | 7.926016275 | 7.883345478 | 0.161210636 | 2.282887931 | 0.02342505  | 16.32447866 | 2.047493728 | 0.171117689 | 0.065056606 |
| plusAl    | 1    | WR   | NA          | NA          | 2.264233588 | 0.386696631 | 0.452431297 | 0.011884281 | 9.085151848 | 7.146180554 | 0.140317296 | 1.910063076 | 0.016394786 | 18.79709825 | 1.85833301  | 0.235983961 | 0.052274841 |
| plusAl    | 2    | WR   | NA          | NA          | 2.206404103 | 0.341703376 | 0.458529164 | 0.01168829  | 8.731725448 | 6.576775241 | 0.139220506 | 1.748115835 | 0.015546869 | 17.47427584 | 1.804809677 | 0.227863596 | 0.048713517 |
| plusAl    | 3    | WR   | NA          | NA          | 2.962639119 | 0.426848682 | 0.622775171 | 0.012487277 | 10.19015074 | 6.904993434 | 0.145521913 | 1.889585345 | 0.01780532  | 19.71281324 | 1.669257134 | 0.285361319 | 0.056009516 |
| plusAl    | 4    | WR   | NA          | NA          | 3.212339726 | 0.344583257 | 0.551871988 | 0.012791352 | 10.79604102 | 6.620098248 | 0.18094168  | 1.73694188  | 0.016549367 | 19.08009234 | 1.633226918 | 0.24373831  | 0.051495428 |

まず，パッケージとデモデータを読み込んでおきます．

```R
# load packages
library(tidyverse)

# import rawdata
rawdata=read.csv("../Data/data_handling_demo.csv")
```



## 列の抽出 (dplyr::select)

#### Case study 1 - n番目の列を抽出

##### 1-1: 6列目のAlだけを抽出

```R
d=rawdata %>% 
  select(6)
print(d)
```

##### 1-2: 1列目から5列目までを抽出

```R
d=rawdata %>% 
  select(1:5)
print(d)
```

##### 1-3: 1-3列目と6-最終列を抽出

```R
# 列番号でselect
d=rawdata %>% 
  select(1:3, 6:18)
print(d)

# 最終列をlength()で取得
d=rawdata %>% 
  select(1:3, 6:length(rawdata))
print(d)

# 最終列をncol()で取得
d=rawdata %>% 
  select(1:3, 6:ncol(rawdata))
print(d)
```



#### Case study 2 - 任意の列名を抽出

##### 2-1: Al列のみを抽出

```R
d=rawdata %>% 
  select(Al)
print(d)
```

##### 2-2: Al-Zn列を抽出

```R
d=rawdata %>% 
  select(Al:Zn)
print(d)
```



## 行の抽出 (dplyr::slice, dplyr::filter)

#### Case study 1 - n番目の行を抽出

##### 1-1: 1行目だけを抽出

```R
d=rawdata %>% 
  slice(1)
print(d)
```

##### 1-2: 1-5行目を抽出

```R
d=rawdata %>% 
  slice(1:5)
print(d)
```

##### 1-3: 1行目と最終行を抽出

```R
d=rawdata %>% 
  slice(1,nrow(rawdata))
print(d)
```



#### Case study 2 - ある条件に基づき抽出 (一致，大小，etc...)

##### 2-1: NLのみを抽出

```R
d=rawdata %>% 
  filter(part=="NL")
print(d)
```

##### 2-2: Alが1以上の列のみ抽出

```R
d=rawdata %>% 
  filter(Al>=1)
print(d)
```

##### 2-3: 複数条件を満たす列のみ抽出

```R
d=rawdata %>% 
  filter(part=="NL" | part=="ML")
print(d)
```



## 列の変更・追加 (dplyr::mutate)

#### Case study 1 - ある列内で文字の置換をしたい

##### 1-1: "minusAl"を"-Al"に，"plusAl"を"+Al"に変換

```R
d=rawdata %>% 
  mutate(treatment=gsub(treatment,pattern="minus",replacement = "-")) %>% 
  mutate(treatment=gsub(treatment,pattern="plus",replacement = "+"))
print(d)
```



#### Case study 2 - 新規の列を追加したい

##### 2-1: Chl aとChl bを基にChl a/bとChl a+b列を追加する

```R
d=rawdata %>% 
  mutate(Chl_a_b_ratio = Chl_a/Chl_b) %>% 
  mutate(Chl_total = Chl_a+Chl_b)
print(d)
```



## ソート (dplyr::arrange)

#### Case study 1 - ある列の値を基に並び替えたい

##### 1-1: Alの昇順にソート

```R
d=rawdata %>% 
  arrange(Al)
print(d)
```

##### 1-2: Alの降順にソート

```R
d=rawdata %>% 
  arrange(desc(Al))
print(d)
```



## 縦長にする (tidyにする．longにする) (tidyr::pivot_longer)

#### Case study 1 - tidyな (longな) データにする

これを

| treatment | n    | part | Chl_a       | Chl_b       | Al          | Fe          | Na          | B           | P           | S           | Si          | Ca          | Cu          | K           | Mg          | Mn          | Zn          |
| --------- | ---- | ---- | ----------- | ----------- | ----------- | ----------- | ----------- | ----------- | ----------- | ----------- | ----------- | ----------- | ----------- | ----------- | ----------- | ----------- | ----------- |
| minusAl   | 1    | NL   | 7.012684391 | 2.353361921 | 0.178765525 | 0.133502088 | 0.604551147 | 0.035487106 | 3.918749999 | 3.2603298   | 0.092385106 | 4.43935116  | 0.006757444 | 9.362802021 | 1.634951748 | 0.593645733 | 0.027605377 |
| minusAl   | 2    | NL   | 6.698333333 | 2.182391714 | 0.167122902 | 0.098583939 | 0.454368808 | 0.032142086 | 4.065937965 | 3.04593638  | 0.103160285 | 3.748617645 | 0.006525771 | 10.23924714 | 1.571978261 | 0.506675137 | 0.031023565 |
| minusAl   | 3    | NL   | 6.407278369 | 2.048280142 | 0.155344844 | 0.108510738 | 0.374604197 | 0.029527298 | 4.097699658 | 3.505802782 | 0.111835804 | 3.449250946 | 0.007949058 | 11.17415479 | 1.811214748 | 0.438575225 | 0.030577295 |
| minusAl   | 4    | NL   | 5.9038      | 1.89248     | 0.199477536 | 0.136366122 | 0.647776262 | 0.029597052 | 4.08363422  | 3.304531473 | 0.112292381 | 4.794553315 | 0.006971217 | 10.21903781 | 1.807767003 | 0.601705904 | 0.030181155 |

こうする

| treatment | n    | part | phenotype | content     |
| --------- | ---- | ---- | --------- | ----------- |
| minusAl   | 1    | NL   | Chl_a     | 7.012684391 |
| minusAl   | 1    | NL   | Chl_b     | 2.353361921 |
| minusAl   | 1    | NL   | Al        | 0.178765525 |
| minusAl   | 1    | NL   | Fe        | 0.133502088 |
| minusAl   | 1    | NL   | Na        | 0.604551147 |
| minusAl   | 1    | NL   | B         | 0.035487106 |
| minusAl   | 1    | NL   | P         | 3.918749999 |
| minusAl   | 1    | NL   | S         | 3.2603298   |
| minusAl   | 1    | NL   | Si        | 0.092385106 |
| minusAl   | 1    | NL   | Ca        | 4.43935116  |
| minusAl   | 1    | NL   | Cu        | 0.006757444 |
| minusAl   | 1    | NL   | K         | 9.362802021 |
| minusAl   | 1    | NL   | Mg        | 1.634951748 |
| minusAl   | 1    | NL   | Mn        | 0.593645733 |
| minusAl   | 1    | NL   | Zn        | 0.027605377 |

```R
# 列名で指定
d=rawdata %>% 
  pivot_longer(Chl_a:Zn, names_to="phenotype", values_to="content")
print(d)

# 列番号で指定
d=rawdata %>% 
  pivot_longer(4:18, names_to="phenotype", values_to="content")
print(d)
```



## 横長にする (wideにする) (tidyr::pivot_wider)

#### Case study 1 - wideなデータにする

pivot_longerの逆で，wideなデータにする

```R
# 一度longデータを作る
d_long=rawdata %>% 
  pivot_longer(Chl_a:Zn, names_to="phenotype", values_to="content")
print(d_long)

# wideにする
d_wide=d_long %>% 
  pivot_wider(names_from=phenotype, values_from=content)
print(d_wide)
```



## 欠損値 (NA) のある行を除く (base::na.omit, tidyr::drop_na)

#### Case study 1 - 1つでもNAのある行は削除する

```R
d=na.omit(rawdata)
print(d)
```



#### Case study 2 - ある列にNAがある場合削除する

##### 2-1: Al列にNAがある行のみを削除 (他の列にNAがあっても残る)

```R
d=rawdata %>% drop_na(Al)
print(d)
```





## グループ化と統計量の算出 (dplyr::group_by)

#### Case study 1 - 処理区，部位ごとの平均値と標準偏差を算出

##### 1-1: 平均値と標準偏差の列を新たに作成

流れ

1. pivot_longerでlongデータにする
2. treatment, part, phenotypeでgroup_byする
3. summarise()でmeanとsdを算出する

```R
d_mean_sd=rawdata %>% 
  pivot_longer(Chl_a:Zn, names_to="phenotype", values_to="content") %>% 
  group_by(treatment, part, phenotype) %>% 
  summarise(mean=mean(content), sd=sd(content))
print(d_mean_sd)
```



##### 1-2: wideな平均値テーブルを作成

流れ

1. pivot_longerでlongデータにする
2. treatment, treatment, part, phenotypeでgroup_byする
3. summarise()でmeanを算出する
4. pivot_widerでwideにする

```R
d_mean_wide=rawdata %>% 
  pivot_longer(Chl_a:Zn, names_to="phenotype", values_to="content") %>% 
  group_by(treatment, part, phenotype) %>% 
  summarise(mean=mean(content)) %>% 
  pivot_wider(names_from=phenotype, values_from=mean)
print(d_mean_wide)
```



##### ungroup()

group_byでグループ化したデータフレームは型がgrouped_dfになっている．

グループ化を解除する場合dplyr::ungroup()で解除できる．

※ grouped_dfであることが不都合な場合がある．

```R
d_mean_sd=d_mean_sd %>% ungroup()
```

```R
d_mean_wide=d_mean_wide %>% ungroup()
```



これらを組み合わせれば，大半のことはできちゃいます．

ex.) 

p値でソートして上位だけ抽出する
p値が0.05未満のみ抽出
etc...
